<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Polymarket - דשבורד שווקי ניבוי</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-deep: #07090E;
  --bg-primary: #0C0F18;
  --bg-card: #111622;
  --bg-card-hover: #161D2E;
  --bg-elevated: #1A2235;
  --border-subtle: rgba(255,255,255,0.06);
  --border-hover: rgba(255,255,255,0.12);
  --text-primary: #E8ECF4;
  --text-secondary: #7B8BA5;
  --text-muted: #4A5568;
  --accent-cyan: #00D4AA;
  --accent-cyan-dim: rgba(0,212,170,0.15);
  --accent-cyan-glow: rgba(0,212,170,0.3);
  --green: #00E676;
  --green-dim: rgba(0,230,118,0.12);
  --green-mid: rgba(0,230,118,0.25);
  --red: #FF5252;
  --red-dim: rgba(255,82,82,0.12);
  --red-mid: rgba(255,82,82,0.25);
  --yellow: #FFD740;
  --yellow-dim: rgba(255,215,64,0.12);
  --font-mono: 'DM Mono', 'Courier New', monospace;
  --font-serif: 'Instrument Serif', Georgia, serif;
  --font-sans: 'DM Sans', -apple-system, sans-serif;
  --radius: 12px;
  --radius-sm: 8px;
}

html { font-size: 15px; }

body {
  background: var(--bg-deep);
  color: var(--text-primary);
  font-family: var(--font-sans);
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  opacity: 0.025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
}

body::after {
  content: '';
  position: fixed;
  top: -40%;
  left: -20%;
  width: 60%;
  height: 60%;
  background: radial-gradient(ellipse, rgba(0,212,170,0.04) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

.app { position: relative; z-index: 1; }

/* ═══ HEADER ═══ */
.header {
  padding: 2rem 2.5rem 1.5rem;
  border-bottom: 1px solid var(--border-subtle);
  background: linear-gradient(180deg, rgba(0,212,170,0.03) 0%, transparent 100%);
}

.header-inner {
  max-width: 1600px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  gap: 2rem;
  flex-wrap: wrap;
}

.header-left { flex: 1; min-width: 300px; }

.header-eyebrow {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--accent-cyan);
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.header-eyebrow .pulse {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--accent-cyan);
  animation: pulse 2s ease-in-out infinite;
  box-shadow: 0 0 8px var(--accent-cyan-glow);
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(0.8); }
}

.header h1 {
  font-family: var(--font-serif);
  font-size: 2.4rem;
  font-weight: 400;
  letter-spacing: -0.02em;
  line-height: 1.1;
  background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.header-subtitle { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.3rem; font-weight: 300; }

.header-right { display: flex; align-items: center; gap: 1.5rem; flex-shrink: 0; }

.refresh-indicator {
  display: flex; align-items: center; gap: 0.6rem;
  font-family: var(--font-mono); font-size: 0.72rem; color: var(--text-muted);
}

.refresh-ring { width: 28px; height: 28px; }
.refresh-ring svg { width: 28px; height: 28px; transform: rotate(-90deg); }
.refresh-ring circle { fill: none; stroke-width: 2; }
.refresh-ring .track { stroke: var(--border-subtle); }
.refresh-ring .progress {
  stroke: var(--accent-cyan); stroke-dasharray: 75.4; stroke-dashoffset: 0;
  transition: stroke-dashoffset 1s linear; stroke-linecap: round;
}

.last-updated {
  font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted);
  padding: 0.4rem 0.7rem; border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm); background: var(--bg-card);
}

/* ═══ STATS BAR ═══ */
.stats-bar {
  max-width: 1600px; margin: 0 auto; padding: 1.2rem 2.5rem;
  display: flex; gap: 0; border-bottom: 1px solid var(--border-subtle);
}

.stat-item {
  flex: 1; padding: 0 1.5rem; border-right: 1px solid var(--border-subtle);
  display: flex; flex-direction: column; gap: 0.2rem;
}
.stat-item:first-child { padding-left: 0; }
.stat-item:last-child { border-right: none; padding-right: 0; }

.stat-label {
  font-family: var(--font-mono); font-size: 0.65rem;
  letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted);
}

.stat-value { font-family: var(--font-mono); font-size: 1.3rem; font-weight: 500; color: var(--text-primary); }
.stat-value.accent { color: var(--accent-cyan); }

/* ═══ CONTROLS ═══ */
.controls {
  max-width: 1600px; margin: 0 auto; padding: 1.2rem 2.5rem;
  display: flex; gap: 0.8rem; align-items: center; flex-wrap: wrap;
}

.search-box { flex: 1; min-width: 250px; max-width: 400px; position: relative; }

.search-box input {
  width: 100%; padding: 0.6rem 1rem 0.6rem 2.4rem;
  background: var(--bg-card); border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm); color: var(--text-primary);
  font-family: var(--font-sans); font-size: 0.82rem; outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.search-box input:focus { border-color: var(--accent-cyan); box-shadow: 0 0 0 3px var(--accent-cyan-dim); }
.search-box input::placeholder { color: var(--text-muted); }

.search-box .search-icon {
  position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%);
  color: var(--text-muted); font-size: 0.85rem; pointer-events: none;
}

.sort-group {
  display: flex; gap: 0; border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm); overflow: hidden;
}

.sort-btn {
  padding: 0.55rem 0.9rem; background: var(--bg-card); border: none;
  border-right: 1px solid var(--border-subtle); color: var(--text-muted);
  font-family: var(--font-mono); font-size: 0.68rem; letter-spacing: 0.03em;
  cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.sort-btn:last-child { border-right: none; }
.sort-btn:hover { color: var(--text-secondary); background: var(--bg-elevated); }
.sort-btn.active { color: var(--accent-cyan); background: var(--accent-cyan-dim); }

.market-count { margin-left: auto; font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted); }

/* ═══ GRID ═══ */
.markets-grid {
  max-width: 1600px; margin: 0 auto; padding: 1.2rem 2.5rem 3rem;
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;
}

/* ═══ CARD ═══ */
.market-card {
  background: var(--bg-card); border: 1px solid var(--border-subtle);
  border-radius: var(--radius); overflow: hidden;
  transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  position: relative; opacity: 0; transform: translateY(12px);
  animation: cardIn 0.5s ease forwards;
  display: block; text-decoration: none; color: inherit;
}

.market-card:hover {
  border-color: var(--border-hover); background: var(--bg-card-hover);
  transform: translateY(-2px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 0 1px rgba(0,212,170,0.05);
}

@keyframes cardIn { to { opacity: 1; transform: translateY(0); } }

.card-header { display: flex; gap: 0.8rem; padding: 1rem 1rem 0.8rem; align-items: flex-start; }

.card-image {
  width: 44px; height: 44px; border-radius: 8px; object-fit: cover;
  flex-shrink: 0; background: var(--bg-elevated); border: 1px solid var(--border-subtle);
}
.card-image.placeholder {
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; color: var(--text-muted);
}

.card-title {
  font-size: 0.85rem; font-weight: 500; line-height: 1.35; color: var(--text-primary);
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden; flex: 1;
}

/* Probability section */
.card-probability { padding: 0 1rem 0.6rem; }

.prob-labels { display: flex; justify-content: space-between; margin-bottom: 0.35rem; }

.prob-label {
  font-family: var(--font-mono); font-size: 0.72rem; font-weight: 500;
  display: flex; align-items: center; gap: 0.3rem;
}
.prob-label.yes { color: var(--green); }
.prob-label.no { color: var(--red); }
.prob-label .pct { font-size: 0.95rem; font-weight: 500; }

.prob-bar {
  height: 6px; border-radius: 3px; overflow: hidden;
  display: flex; background: var(--red-dim);
}

.prob-bar-yes {
  height: 100%;
  background: linear-gradient(90deg, var(--green) 0%, rgba(0,230,118,0.7) 100%);
  border-radius: 3px; transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  position: relative; box-shadow: 0 0 8px var(--green-dim);
}
.prob-bar-yes::after {
  content: ''; position: absolute; right: 0; top: 0; bottom: 0;
  width: 2px; background: white; border-radius: 1px; opacity: 0.6;
}

/* ═══ SPARKLINE (in-card) ═══ */
.card-chart {
  padding: 0.2rem 1rem 0.6rem;
  position: relative;
  cursor: pointer;
}

.card-chart:hover .chart-expand-hint { opacity: 1; }

.chart-expand-hint {
  position: absolute; top: 4px; right: 1rem;
  font-family: var(--font-mono); font-size: 0.58rem;
  color: var(--accent-cyan); opacity: 0; transition: opacity 0.2s;
  background: var(--bg-card); padding: 0 4px; border-radius: 3px;
}

.sparkline-canvas {
  width: 100%; height: 50px; display: block; border-radius: 4px;
}

.chart-loading {
  height: 50px; display: flex; align-items: center; justify-content: center;
  font-family: var(--font-mono); font-size: 0.65rem; color: var(--text-muted);
}

.chart-timerange {
  display: flex; justify-content: space-between; margin-top: 0.2rem;
  font-family: var(--font-mono); font-size: 0.55rem; color: var(--text-muted);
}

/* ═══ MODAL CHART ═══ */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  backdrop-filter: blur(6px); z-index: 10000;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; animation: fadeIn 0.2s ease forwards;
}

@keyframes fadeIn { to { opacity: 1; } }

.modal-content {
  background: var(--bg-primary); border: 1px solid var(--border-hover);
  border-radius: 16px; width: 90%; max-width: 900px; max-height: 90vh;
  overflow: auto; position: relative;
  box-shadow: 0 24px 80px rgba(0,0,0,0.5), 0 0 0 1px rgba(0,212,170,0.08);
  animation: modalSlide 0.3s ease forwards;
}

@keyframes modalSlide {
  from { transform: translateY(20px) scale(0.97); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}

.modal-header {
  display: flex; align-items: flex-start; gap: 1rem;
  padding: 1.5rem 1.5rem 1rem; border-bottom: 1px solid var(--border-subtle);
}

.modal-header img {
  width: 48px; height: 48px; border-radius: 10px;
  object-fit: cover; border: 1px solid var(--border-subtle);
}

.modal-header-text { flex: 1; }

.modal-title {
  font-size: 1.1rem; font-weight: 600; line-height: 1.3; color: var(--text-primary);
}

.modal-subtitle {
  font-family: var(--font-mono); font-size: 0.75rem;
  color: var(--text-secondary); margin-top: 0.2rem;
}

.modal-close {
  width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border-subtle);
  background: var(--bg-elevated); color: var(--text-secondary);
  font-size: 1.1rem; cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: all 0.2s; flex-shrink: 0;
}
.modal-close:hover { background: var(--red-dim); color: var(--red); border-color: var(--red); }

.modal-chart-area { padding: 1.5rem; }

.modal-timeframe-btns {
  display: flex; gap: 0; margin-bottom: 1rem;
  border: 1px solid var(--border-subtle); border-radius: var(--radius-sm);
  overflow: hidden; width: fit-content;
}

.tf-btn {
  padding: 0.45rem 1rem; background: var(--bg-card); border: none;
  border-right: 1px solid var(--border-subtle); color: var(--text-muted);
  font-family: var(--font-mono); font-size: 0.7rem; cursor: pointer; transition: all 0.2s;
}
.tf-btn:last-child { border-right: none; }
.tf-btn:hover { color: var(--text-secondary); }
.tf-btn.active { color: var(--accent-cyan); background: var(--accent-cyan-dim); }

.modal-canvas-wrap {
  position: relative; background: var(--bg-card); border: 1px solid var(--border-subtle);
  border-radius: var(--radius); padding: 1rem; overflow: hidden;
}

.modal-canvas { width: 100%; height: 350px; display: block; }

.modal-chart-info {
  display: flex; gap: 2rem; padding: 1rem 1.5rem 1.5rem;
  border-top: 1px solid var(--border-subtle);
}

.modal-info-item {
  display: flex; flex-direction: column; gap: 0.15rem;
}

.modal-info-label {
  font-family: var(--font-mono); font-size: 0.6rem;
  letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted);
}

.modal-info-value {
  font-family: var(--font-mono); font-size: 0.9rem; font-weight: 500;
}

.modal-info-value.up { color: var(--green); }
.modal-info-value.down { color: var(--red); }
.modal-info-value.neutral { color: var(--text-secondary); }

/* Tooltip on modal chart */
.chart-tooltip {
  position: absolute; background: var(--bg-elevated); border: 1px solid var(--border-hover);
  border-radius: 6px; padding: 0.4rem 0.6rem; pointer-events: none;
  font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-primary);
  white-space: nowrap; z-index: 10; display: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.chart-tooltip .tt-price { font-size: 0.85rem; font-weight: 500; color: var(--accent-cyan); }
.chart-tooltip .tt-date { font-size: 0.6rem; color: var(--text-muted); margin-top: 2px; }

.chart-crosshair {
  position: absolute; top: 0; width: 1px; height: 100%;
  background: rgba(255,255,255,0.15); pointer-events: none; display: none;
}

.chart-dot {
  position: absolute; width: 8px; height: 8px; border-radius: 50%;
  background: var(--accent-cyan); border: 2px solid var(--bg-card);
  pointer-events: none; display: none; transform: translate(-50%, -50%);
  box-shadow: 0 0 10px var(--accent-cyan-glow);
}

/* Metrics */
.card-metrics {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 0; padding: 0; border-top: 1px solid var(--border-subtle);
}

.metric {
  padding: 0.6rem 0.8rem; border-right: 1px solid var(--border-subtle); text-align: center;
}
.metric:last-child { border-right: none; }

.metric-label {
  font-family: var(--font-mono); font-size: 0.58rem;
  letter-spacing: 0.08em; text-transform: uppercase;
  color: var(--text-muted); margin-bottom: 0.15rem;
}

.metric-value { font-family: var(--font-mono); font-size: 0.78rem; font-weight: 500; color: var(--text-secondary); }

.card-link-arrow {
  position: absolute; top: 1rem; right: 0.8rem;
  width: 22px; height: 22px; display: flex; align-items: center; justify-content: center;
  border-radius: 4px; background: transparent; color: var(--text-muted);
  font-size: 0.7rem; transition: all 0.2s; opacity: 0;
}
.market-card:hover .card-link-arrow { opacity: 1; background: var(--accent-cyan-dim); color: var(--accent-cyan); }

/* ═══ MULTI-OUTCOME ═══ */
.card-outcomes { padding: 0 1rem 0.6rem; display: flex; flex-direction: column; gap: 0.3rem; }

.outcome-row { display: flex; align-items: center; gap: 0.5rem; }

.outcome-name {
  font-size: 0.72rem; color: var(--text-secondary); flex: 1;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0;
}

.outcome-bar-wrap {
  flex: 1.5; height: 4px; background: var(--bg-elevated);
  border-radius: 2px; overflow: hidden;
}

.outcome-bar-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }

.outcome-pct {
  font-family: var(--font-mono); font-size: 0.7rem; font-weight: 500;
  min-width: 38px; text-align: right;
}

/* ═══ LOADING ═══ */
.loading-state {
  max-width: 1600px; margin: 0 auto; padding: 4rem 2.5rem;
  display: flex; flex-direction: column; align-items: center; gap: 1.5rem;
}

.loading-spinner {
  width: 40px; height: 40px; border: 2px solid var(--border-subtle);
  border-top-color: var(--accent-cyan); border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text { font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-muted); }

.skeleton-grid {
  max-width: 1600px; margin: 0 auto; padding: 1.2rem 2.5rem;
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;
}

.skeleton-card {
  background: var(--bg-card); border: 1px solid var(--border-subtle);
  border-radius: var(--radius); height: 260px; position: relative; overflow: hidden;
}
.skeleton-card::after {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.02) 50%, transparent 100%);
  animation: shimmer 1.5s ease-in-out infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* ═══ ERROR ═══ */
.error-state { max-width: 1600px; margin: 0 auto; padding: 4rem 2.5rem; text-align: center; }
.error-icon { font-size: 2rem; margin-bottom: 1rem; opacity: 0.5; }
.error-title { font-family: var(--font-serif); font-size: 1.3rem; color: var(--text-primary); margin-bottom: 0.5rem; }
.error-msg { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.5rem; }

.retry-btn {
  padding: 0.6rem 1.5rem; background: var(--accent-cyan-dim);
  border: 1px solid var(--accent-cyan); border-radius: var(--radius-sm);
  color: var(--accent-cyan); font-family: var(--font-mono); font-size: 0.8rem;
  cursor: pointer; transition: all 0.2s;
}
.retry-btn:hover { background: var(--accent-cyan-glow); box-shadow: 0 0 16px var(--accent-cyan-dim); }

.empty-state {
  grid-column: 1 / -1; text-align: center; padding: 3rem;
  color: var(--text-muted); font-family: var(--font-mono); font-size: 0.85rem;
}

/* ═══ RESPONSIVE ═══ */
@media (max-width: 1100px) {
  .markets-grid, .skeleton-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 700px) {
  .header { padding: 1.5rem 1.2rem 1rem; }
  .header h1 { font-size: 1.8rem; }
  .stats-bar { padding: 1rem 1.2rem; flex-wrap: wrap; gap: 0.8rem; }
  .stat-item { border-right: none; padding: 0; min-width: 45%; }
  .controls { padding: 1rem 1.2rem; }
  .search-box { min-width: 100%; max-width: 100%; }
  .sort-group { flex-wrap: wrap; }
  .markets-grid, .skeleton-grid { grid-template-columns: 1fr; padding: 1rem 1.2rem 2rem; }
  .modal-content { width: 96%; border-radius: 12px; }
  .modal-canvas { height: 250px; }
  .modal-chart-info { flex-wrap: wrap; gap: 1rem; }
}

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-deep); }
::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* ═══ RTL OVERRIDES ═══ */
.stat-item { border-right: none; border-left: 1px solid var(--border-subtle); }
.stat-item:first-child { padding-right: 0; }
.stat-item:last-child { border-left: none; padding-left: 0; }

.search-box .search-icon { left: auto; right: 0.8rem; }
.search-box input { padding: 0.6rem 2.4rem 0.6rem 1rem; }

.sort-btn { border-right: none; border-left: 1px solid var(--border-subtle); }
.sort-btn:last-child { border-left: none; }

.market-count { margin-left: 0; margin-right: auto; }

.metric { border-right: none; border-left: 1px solid var(--border-subtle); }
.metric:last-child { border-left: none; }

.card-link-arrow { right: auto; left: 0.8rem; }

.outcome-pct { text-align: left; }

.chart-expand-hint { right: auto; left: 1rem; }

.prob-bar-yes { direction: ltr; }

@media (max-width: 700px) {
  .stat-item { border-left: none; }
}
</style>
</head>
<body>
<div class="app">

  <header class="header">
    <div class="header-inner">
      <div class="header-left">
        <div class="header-eyebrow"><span class="pulse"></span><span>נתונים בזמן אמת</span></div>
        <h1>דשבורד Polymarket</h1>
        <p class="header-subtitle">מודיעין שווקי ניבוי בזמן אמת</p>
      </div>
      <div class="header-right">
        <div class="refresh-indicator">
          <div class="refresh-ring">
            <svg viewBox="0 0 28 28">
              <circle class="track" cx="14" cy="14" r="12"/>
              <circle class="progress" id="refreshProgress" cx="14" cy="14" r="12"/>
            </svg>
          </div>
          <span id="refreshCountdown">30s</span>
        </div>
        <div class="last-updated" id="lastUpdated">--:--:--</div>
      </div>
    </div>
  </header>

  <div class="stats-bar">
    <div class="stat-item"><span class="stat-label">שווקים</span><span class="stat-value accent" id="statMarkets">&mdash;</span></div>
    <div class="stat-item"><span class="stat-label">מחזור 24 שע'</span><span class="stat-value" id="statVolume24h">&mdash;</span></div>
    <div class="stat-item"><span class="stat-label">מחזור כולל</span><span class="stat-value" id="statTotalVolume">&mdash;</span></div>
    <div class="stat-item"><span class="stat-label">מרווח ממוצע</span><span class="stat-value" id="statSpread">&mdash;</span></div>
  </div>

  <div class="controls">
    <div class="search-box">
      <span class="search-icon">&#x1F50D;</span>
      <input type="text" id="searchInput" placeholder="חיפוש שווקים..." />
    </div>
    <div class="sort-group">
      <button class="sort-btn active" data-sort="volume24hr">מחזור 24שע'</button>
      <button class="sort-btn" data-sort="volume">מחזור כולל</button>
      <button class="sort-btn" data-sort="liquidity">נזילות</button>
      <button class="sort-btn" data-sort="yesHigh">כן% גבוה</button>
      <button class="sort-btn" data-sort="yesLow">כן% נמוך</button>
    </div>
    <span class="market-count" id="marketCount"></span>
  </div>

  <div id="content">
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <div class="loading-text">טוען נתוני שוק...</div>
    </div>
    <div class="skeleton-grid">
      <div class="skeleton-card"></div><div class="skeleton-card"></div><div class="skeleton-card"></div>
      <div class="skeleton-card"></div><div class="skeleton-card"></div><div class="skeleton-card"></div>
    </div>
  </div>

</div>

<!-- Modal container -->
<div id="modalRoot"></div>

<script>
const REFRESH_INTERVAL = 60;

// Data is served as static JSON from the same origin (updated by GitHub Actions every 5 min)
const DATA_BASE = './data';

let allEvents = [];
let currentSort = 'volume24hr';
let searchQuery = '';
let refreshTimer = null;
let countdown = REFRESH_INTERVAL;

// Cache for price history data
const priceCache = new Map();
// Manifest of available chart files
let chartsManifest = {};

// ─── Helpers ───
function formatUSD(n) {
  if (n == null || isNaN(n)) return '$0';
  n = Number(n);
  if (n >= 1e9) return '$' + (n / 1e9).toFixed(1) + 'B';
  if (n >= 1e6) return '$' + (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return '$' + (n / 1e3).toFixed(1) + 'K';
  return '$' + n.toFixed(0);
}

function formatPct(n) {
  if (n == null || isNaN(n)) return '0%';
  return (Number(n) * 100).toFixed(1) + '%';
}

function timeNow() { return new Date().toLocaleTimeString('en-US', { hour12: false }); }

function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatDate(ts) {
  const d = new Date(ts * 1000);
  return d.toLocaleDateString('he-IL', { month: 'short', day: 'numeric' });
}

function formatDateTime(ts) {
  const d = new Date(ts * 1000);
  return d.toLocaleDateString('he-IL', { month: 'short', day: 'numeric', year: 'numeric' })
    + ' ' + d.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit', hour12: false });
}

const OUTCOME_COLORS = ['#00E676','#448AFF','#FF9100','#E040FB','#FFD740','#18FFFF','#FF5252','#69F0AE','#7C4DFF','#FF6E40'];
function getOutcomeColor(i) { return OUTCOME_COLORS[i % OUTCOME_COLORS.length]; }

// ─── Fetch ───
async function fetchMarkets() {
  // Load static JSON (updated by GitHub Actions every 5 min)
  const r = await fetch(`${DATA_BASE}/events.json?t=${Date.now()}`);
  if (!r.ok) throw new Error(`Failed to load events data (${r.status})`);
  return r.json();
}

async function fetchMeta() {
  try {
    const r = await fetch(`${DATA_BASE}/meta.json?t=${Date.now()}`);
    if (r.ok) return r.json();
  } catch {}
  return null;
}

async function loadChartsManifest() {
  try {
    const r = await fetch(`${DATA_BASE}/charts_manifest.json?t=${Date.now()}`);
    if (r.ok) chartsManifest = await r.json();
  } catch {}
}

async function fetchPriceHistory(tokenId, interval = 'max', fidelity = 60) {
  // For static data, we only have the 'max' interval pre-fetched
  const prefix = tokenId.substring(0, 20);
  const key = `${prefix}_${interval}`;
  if (priceCache.has(key)) return priceCache.get(key);

  // Check if chart file exists in manifest
  if (!chartsManifest[prefix] && interval === 'max') {
    return [];
  }

  try {
    const r = await fetch(`${DATA_BASE}/charts/${prefix}.json?t=${Date.now()}`);
    if (!r.ok) return [];
    const d = await r.json();
    let history = d.history || [];

    // Apply interval filter client-side
    if (interval !== 'max' && history.length > 0) {
      const now = history[history.length - 1].t;
      const intervals = { '1d': 86400, '1w': 604800, '1m': 2592000, '3m': 7776000 };
      const cutoff = now - (intervals[interval] || 0);
      if (intervals[interval]) {
        history = history.filter(h => h.t >= cutoff);
      }
    }

    priceCache.set(key, history);
    return history;
  } catch { return []; }
}

// ─── Parse ───
function parseEvent(event) {
  const markets = event.markets || [];
  const isMulti = markets.length > 1;
  let yesPrice = 0, noPrice = 0, outcomes = [];

  // Get the primary token ID for chart (YES token of first market)
  let primaryTokenId = null;
  if (markets.length > 0) {
    try {
      const tokens = JSON.parse(markets[0].clobTokenIds || '[]');
      primaryTokenId = tokens[0] || null;
    } catch {}
  }

  if (isMulti) {
    outcomes = markets.map((m, i) => {
      let prices = [];
      try { prices = JSON.parse(m.outcomePrices || '[]'); } catch {}
      let tokenId = null;
      try { const t = JSON.parse(m.clobTokenIds || '[]'); tokenId = t[0]; } catch {}
      return {
        name: m.groupItemTitle || m.question || `Outcome ${i+1}`,
        price: prices[0] ? Number(prices[0]) : 0,
        color: getOutcomeColor(i),
        tokenId,
      };
    }).sort((a, b) => b.price - a.price);
    yesPrice = outcomes[0]?.price || 0;
    noPrice = 1 - yesPrice;
    primaryTokenId = outcomes[0]?.tokenId || primaryTokenId;
  } else if (markets.length === 1) {
    let prices = [];
    try { prices = JSON.parse(markets[0].outcomePrices || '[]'); } catch {}
    yesPrice = prices[0] ? Number(prices[0]) : 0;
    noPrice = prices[1] ? Number(prices[1]) : 1 - yesPrice;
  }

  return {
    id: event.id, title: event.title, slug: event.slug,
    image: event.image || (markets[0] && markets[0].image) || null,
    volume: Number(event.volume || 0),
    volume24hr: Number(event.volume24hr || 0),
    liquidity: Number(event.liquidity || 0),
    yesPrice, noPrice, isMulti, outcomes, markets, primaryTokenId,
  };
}

// ─── Drawing: Sparkline (in-card) ───
function drawSparkline(canvas, history, color = '#00D4AA') {
  if (!history || history.length < 2) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  ctx.scale(dpr, dpr);

  const prices = history.map(p => p.p);
  const min = Math.min(...prices);
  const max = Math.max(...prices);
  const range = max - min || 0.01;
  const pad = 2;

  // Determine trend color
  const first = prices[0], last = prices[prices.length - 1];
  const trendColor = last >= first ? '#00E676' : '#FF5252';

  // Draw gradient fill
  const grad = ctx.createLinearGradient(0, 0, 0, h);
  grad.addColorStop(0, trendColor + '25');
  grad.addColorStop(1, trendColor + '02');

  ctx.beginPath();
  ctx.moveTo(0, h);
  for (let i = 0; i < prices.length; i++) {
    const x = (i / (prices.length - 1)) * w;
    const y = pad + (1 - (prices[i] - min) / range) * (h - pad * 2);
    if (i === 0) ctx.lineTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.lineTo(w, h);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Draw line
  ctx.beginPath();
  for (let i = 0; i < prices.length; i++) {
    const x = (i / (prices.length - 1)) * w;
    const y = pad + (1 - (prices[i] - min) / range) * (h - pad * 2);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.strokeStyle = trendColor;
  ctx.lineWidth = 1.5;
  ctx.lineJoin = 'round';
  ctx.stroke();

  // End dot
  const lastX = w;
  const lastY = pad + (1 - (last - min) / range) * (h - pad * 2);
  ctx.beginPath();
  ctx.arc(lastX - 1, lastY, 2.5, 0, Math.PI * 2);
  ctx.fillStyle = trendColor;
  ctx.fill();
}

// ─── Drawing: Full Chart (modal) ───
function drawFullChart(canvas, history) {
  if (!history || history.length < 2) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  ctx.scale(dpr, dpr);

  const prices = history.map(p => p.p);
  const times = history.map(p => p.t);
  const min = Math.min(...prices);
  const max = Math.max(...prices);
  const range = max - min || 0.01;
  const padT = 20, padB = 28, padL = 50, padR = 15;
  const cw = w - padL - padR;
  const ch = h - padT - padB;

  const first = prices[0], last = prices[prices.length - 1];
  const lineColor = last >= first ? '#00E676' : '#FF5252';

  // Grid lines
  const gridSteps = 5;
  ctx.strokeStyle = 'rgba(255,255,255,0.04)';
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 4]);
  for (let i = 0; i <= gridSteps; i++) {
    const y = padT + (i / gridSteps) * ch;
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(w - padR, y); ctx.stroke();
    // Price label
    const price = max - (i / gridSteps) * range;
    ctx.fillStyle = '#4A5568';
    ctx.font = '10px "DM Mono", monospace';
    ctx.textAlign = 'right';
    ctx.fillText((price * 100).toFixed(1) + '%', padL - 8, y + 4);
  }
  ctx.setLineDash([]);

  // Date labels
  const dateSteps = Math.min(6, history.length);
  ctx.fillStyle = '#4A5568';
  ctx.font = '10px "DM Mono", monospace';
  ctx.textAlign = 'center';
  for (let i = 0; i <= dateSteps; i++) {
    const idx = Math.round((i / dateSteps) * (history.length - 1));
    const x = padL + (idx / (history.length - 1)) * cw;
    ctx.fillText(formatDate(times[idx]), x, h - 6);
  }

  // Gradient fill
  const grad = ctx.createLinearGradient(0, padT, 0, padT + ch);
  grad.addColorStop(0, lineColor + '20');
  grad.addColorStop(1, lineColor + '02');

  ctx.beginPath();
  ctx.moveTo(padL, padT + ch);
  for (let i = 0; i < prices.length; i++) {
    const x = padL + (i / (prices.length - 1)) * cw;
    const y = padT + (1 - (prices[i] - min) / range) * ch;
    ctx.lineTo(x, y);
  }
  ctx.lineTo(padL + cw, padT + ch);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  for (let i = 0; i < prices.length; i++) {
    const x = padL + (i / (prices.length - 1)) * cw;
    const y = padT + (1 - (prices[i] - min) / range) * ch;
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  }
  ctx.strokeStyle = lineColor;
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  ctx.stroke();

  // Store chart geometry for tooltip
  canvas._chartMeta = { padL, padR, padT, padB, cw, ch, min, max, range, prices, times, lineColor };
}

// ─── Modal tooltip hover ───
function setupModalTooltip(canvas, tooltip, crosshair, dot) {
  const meta = canvas._chartMeta;
  if (!meta) return;

  const wrap = canvas.parentElement;

  wrap.addEventListener('mousemove', (e) => {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    const { padL, padR, padT, cw, ch, min, range, prices, times, lineColor } = meta;

    if (mx < padL || mx > padL + cw) {
      tooltip.style.display = 'none';
      crosshair.style.display = 'none';
      dot.style.display = 'none';
      return;
    }

    const ratio = (mx - padL) / cw;
    const idx = Math.round(ratio * (prices.length - 1));
    const price = prices[idx];
    const time = times[idx];
    const x = padL + (idx / (prices.length - 1)) * cw;
    const y = padT + (1 - (price - min) / range) * ch;

    crosshair.style.display = 'block';
    crosshair.style.left = x + 'px';

    dot.style.display = 'block';
    dot.style.left = x + 'px';
    dot.style.top = y + 'px';
    dot.style.background = lineColor;

    tooltip.style.display = 'block';
    tooltip.innerHTML = `<div class="tt-price">${(price * 100).toFixed(2)}%</div><div class="tt-date">${formatDateTime(time)}</div>`;
    let tx = x + 12, ty = y - 40;
    if (tx + 140 > canvas.clientWidth) tx = x - 140;
    if (ty < 0) ty = y + 12;
    tooltip.style.left = tx + 'px';
    tooltip.style.top = ty + 'px';
  });

  wrap.addEventListener('mouseleave', () => {
    tooltip.style.display = 'none';
    crosshair.style.display = 'none';
    dot.style.display = 'none';
  });
}

// ─── Modal ───
let currentModalEvent = null;
let currentModalInterval = 'max';

function openModal(event) {
  currentModalEvent = event;
  currentModalInterval = 'max';
  const root = document.getElementById('modalRoot');

  root.innerHTML = `
    <div class="modal-overlay" id="modalOverlay">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          ${event.image ? `<img src="${escHtml(event.image)}" alt="" onerror="this.style.display='none'">` : ''}
          <div class="modal-header-text">
            <div class="modal-title">${escHtml(event.title)}</div>
            <div class="modal-subtitle">
              ${event.isMulti ? event.outcomes.length + ' תוצאות' : 'כן ' + formatPct(event.yesPrice) + ' / לא ' + formatPct(event.noPrice)}
              &bull; מחזור ${formatUSD(event.volume)} &bull; 24שע' ${formatUSD(event.volume24hr)}
            </div>
          </div>
          <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <div class="modal-chart-area">
          <div class="modal-timeframe-btns" id="tfBtns">
            <button class="tf-btn" data-tf="1d" data-fid="5">1D</button>
            <button class="tf-btn" data-tf="1w" data-fid="30">1W</button>
            <button class="tf-btn" data-tf="1m" data-fid="60">1M</button>
            <button class="tf-btn" data-tf="3m" data-fid="120">3M</button>
            <button class="tf-btn active" data-tf="max" data-fid="60">ALL</button>
          </div>
          <div class="modal-canvas-wrap" id="modalCanvasWrap">
            <canvas class="modal-canvas" id="modalCanvas"></canvas>
            <div class="chart-crosshair" id="chartCrosshair"></div>
            <div class="chart-dot" id="chartDot"></div>
            <div class="chart-tooltip" id="chartTooltip"></div>
          </div>
        </div>
        <div class="modal-chart-info" id="modalInfo"></div>
      </div>
    </div>`;

  document.getElementById('modalOverlay').addEventListener('click', closeModal);
  document.getElementById('modalClose').addEventListener('click', closeModal);
  document.addEventListener('keydown', modalKeyHandler);

  document.querySelectorAll('#tfBtns .tf-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#tfBtns .tf-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadModalChart(event.primaryTokenId, btn.dataset.tf, Number(btn.dataset.fid));
    });
  });

  loadModalChart(event.primaryTokenId, 'max', 60);
}

function closeModal() {
  document.getElementById('modalRoot').innerHTML = '';
  document.removeEventListener('keydown', modalKeyHandler);
  currentModalEvent = null;
}

function modalKeyHandler(e) { if (e.key === 'Escape') closeModal(); }

async function loadModalChart(tokenId, interval, fidelity) {
  const canvas = document.getElementById('modalCanvas');
  const infoEl = document.getElementById('modalInfo');
  if (!canvas) return;

  // Show loading
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  canvas.width = canvas.clientWidth * dpr;
  canvas.height = canvas.clientHeight * dpr;
  ctx.scale(dpr, dpr);
  ctx.fillStyle = '#4A5568';
  ctx.font = '13px "DM Mono", monospace';
  ctx.textAlign = 'center';
  ctx.fillText('...טוען נתוני גרף', canvas.clientWidth / 2, canvas.clientHeight / 2);

  const history = await fetchPriceHistory(tokenId, interval, fidelity);

  if (history.length < 2) {
    ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);
    ctx.fillStyle = '#4A5568';
    ctx.font = '13px "DM Mono", monospace';
    ctx.textAlign = 'center';
    ctx.fillText('אין היסטוריית מחירים לטווח זמן זה', canvas.clientWidth / 2, canvas.clientHeight / 2);
    infoEl.innerHTML = '';
    return;
  }

  drawFullChart(canvas, history);
  setupModalTooltip(
    canvas,
    document.getElementById('chartTooltip'),
    document.getElementById('chartCrosshair'),
    document.getElementById('chartDot')
  );

  // Info bar
  const first = history[0].p, last = history[history.length - 1].p;
  const change = last - first;
  const changePct = first > 0 ? (change / first) * 100 : 0;
  const hi = Math.max(...history.map(h => h.p));
  const lo = Math.min(...history.map(h => h.p));
  const cls = change >= 0 ? 'up' : 'down';
  const arrow = change >= 0 ? '&#9650;' : '&#9660;';

  infoEl.innerHTML = `
    <div class="modal-info-item">
      <span class="modal-info-label">נוכחי</span>
      <span class="modal-info-value neutral">${(last * 100).toFixed(2)}%</span>
    </div>
    <div class="modal-info-item">
      <span class="modal-info-label">שינוי</span>
      <span class="modal-info-value ${cls}">${arrow} ${Math.abs(change * 100).toFixed(2)}pp (${changePct >= 0 ? '+' : ''}${changePct.toFixed(1)}%)</span>
    </div>
    <div class="modal-info-item">
      <span class="modal-info-label">שיא</span>
      <span class="modal-info-value neutral">${(hi * 100).toFixed(2)}%</span>
    </div>
    <div class="modal-info-item">
      <span class="modal-info-label">שפל</span>
      <span class="modal-info-value neutral">${(lo * 100).toFixed(2)}%</span>
    </div>
    <div class="modal-info-item">
      <span class="modal-info-label">נקודות נתונים</span>
      <span class="modal-info-value neutral">${history.length}</span>
    </div>`;
}

// ─── Card Rendering ───
function renderCard(event, index) {
  const delay = index * 50;
  const cardId = `card-${event.id}`;

  let probSection = '';
  if (event.isMulti && event.outcomes.length > 0) {
    const top = event.outcomes.slice(0, 4);
    probSection = `<div class="card-outcomes">
      ${top.map(o => `<div class="outcome-row">
        <span class="outcome-name">${escHtml(o.name)}</span>
        <div class="outcome-bar-wrap"><div class="outcome-bar-fill" style="width:${(o.price*100).toFixed(1)}%;background:${o.color};box-shadow:0 0 6px ${o.color}33"></div></div>
        <span class="outcome-pct" style="color:${o.color}">${formatPct(o.price)}</span>
      </div>`).join('')}
      ${event.outcomes.length > 4 ? `<div class="outcome-row"><span class="outcome-name" style="color:var(--text-muted);font-style:italic">+${event.outcomes.length - 4} תוצאות נוספות</span></div>` : ''}
    </div>`;
  } else {
    probSection = `<div class="card-probability">
      <div class="prob-labels">
        <span class="prob-label yes">כן <span class="pct">${formatPct(event.yesPrice)}</span></span>
        <span class="prob-label no"><span class="pct">${formatPct(event.noPrice)}</span> לא</span>
      </div>
      <div class="prob-bar"><div class="prob-bar-yes" style="width:${(event.yesPrice*100).toFixed(1)}%"></div></div>
    </div>`;
  }

  const imgHtml = event.image
    ? `<img class="card-image" src="${escHtml(event.image)}" alt="" loading="lazy" onerror="this.outerHTML='<div class=\\'card-image placeholder\\'>&#x25C8;</div>'">`
    : `<div class="card-image placeholder">&#x25C8;</div>`;

  return `<div class="market-card" style="animation-delay:${delay}ms" data-event-id="${event.id}" data-slug="${escHtml(event.slug)}">
    <a class="card-link-arrow" href="https://polymarket.com/event/${escHtml(event.slug)}" target="_blank" rel="noopener" onclick="event.stopPropagation()">&#x2197;</a>
    <div class="card-header">
      ${imgHtml}
      <div class="card-title">${escHtml(event.title)}</div>
    </div>
    ${probSection}
    <div class="card-chart" data-token="${event.primaryTokenId || ''}" id="${cardId}-chart">
      <div class="chart-loading" id="${cardId}-loading">טוען גרף...</div>
      <canvas class="sparkline-canvas" id="${cardId}-canvas" style="display:none"></canvas>
      <div class="chart-timerange" id="${cardId}-range" style="display:none">
        <span id="${cardId}-start"></span>
        <span id="${cardId}-end"></span>
      </div>
      <span class="chart-expand-hint">לחץ להרחבה</span>
    </div>
    <div class="card-metrics">
      <div class="metric"><div class="metric-label">מחזור 24שע'</div><div class="metric-value">${formatUSD(event.volume24hr)}</div></div>
      <div class="metric"><div class="metric-label">מחזור</div><div class="metric-value">${formatUSD(event.volume)}</div></div>
      <div class="metric"><div class="metric-label">נזילות</div><div class="metric-value">${formatUSD(event.liquidity)}</div></div>
    </div>
  </div>`;
}

// ─── Sort/Filter ───
function getFiltered() {
  let items = allEvents.map(parseEvent);
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    items = items.filter(e => e.title.toLowerCase().includes(q));
  }
  items.sort((a, b) => {
    switch (currentSort) {
      case 'volume24hr': return b.volume24hr - a.volume24hr;
      case 'volume': return b.volume - a.volume;
      case 'liquidity': return b.liquidity - a.liquidity;
      case 'yesHigh': return b.yesPrice - a.yesPrice;
      case 'yesLow': return a.yesPrice - b.yesPrice;
      default: return 0;
    }
  });
  return items;
}

// ─── Master Render ───
function renderAll() {
  const items = getFiltered();
  const contentEl = document.getElementById('content');

  document.getElementById('statMarkets').textContent = items.length;
  document.getElementById('statVolume24h').textContent = formatUSD(items.reduce((s, e) => s + e.volume24hr, 0));
  document.getElementById('statTotalVolume').textContent = formatUSD(items.reduce((s, e) => s + e.volume, 0));
  const spreads = items.filter(e => !e.isMulti).map(e => Math.abs(e.yesPrice - e.noPrice));
  document.getElementById('statSpread').textContent = formatPct(spreads.length > 0 ? spreads.reduce((a,b) => a+b, 0) / spreads.length : 0);
  document.getElementById('marketCount').textContent = `${items.length} שווקים`;

  if (items.length === 0) {
    contentEl.innerHTML = `<div class="markets-grid"><div class="empty-state">לא נמצאו שווקים תואמים לחיפוש.</div></div>`;
    return;
  }

  contentEl.innerHTML = `<div class="markets-grid">${items.map((e, i) => renderCard(e, i)).join('')}</div>`;

  // Attach click handlers for chart expand (open modal)
  document.querySelectorAll('.market-card').forEach(card => {
    card.addEventListener('click', (e) => {
      // Don't open modal if clicking the external link
      if (e.target.closest('.card-link-arrow')) return;
      const eventId = card.dataset.eventId;
      const ev = items.find(i => String(i.id) === String(eventId));
      if (ev) openModal(ev);
    });
  });

  // Load sparklines lazily
  loadSparklines(items);
}

// ─── Lazy Sparkline Loading ───
async function loadSparklines(items) {
  // Use IntersectionObserver to load charts only when visible
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const chartDiv = entry.target;
        const tokenId = chartDiv.dataset.token;
        const cardId = chartDiv.id.replace('-chart', '');
        if (tokenId) {
          loadSingleSparkline(cardId, tokenId);
        } else {
          const loading = document.getElementById(`${cardId}-loading`);
          if (loading) loading.textContent = 'אין נתוני גרף';
        }
        observer.unobserve(chartDiv);
      }
    });
  }, { rootMargin: '100px' });

  document.querySelectorAll('.card-chart').forEach(el => observer.observe(el));
}

async function loadSingleSparkline(cardId, tokenId) {
  const loading = document.getElementById(`${cardId}-loading`);
  const canvas = document.getElementById(`${cardId}-canvas`);
  const range = document.getElementById(`${cardId}-range`);
  if (!canvas) return;

  const history = await fetchPriceHistory(tokenId, 'max', 60);

  if (history.length < 2) {
    // Try 1 week if max is empty
    const weekHistory = await fetchPriceHistory(tokenId, '1w', 10);
    if (weekHistory.length >= 2) {
      drawSparklineWithData(cardId, weekHistory);
    } else {
      if (loading) loading.textContent = 'אין נתוני גרף';
    }
    return;
  }

  drawSparklineWithData(cardId, history);
}

function drawSparklineWithData(cardId, history) {
  const loading = document.getElementById(`${cardId}-loading`);
  const canvas = document.getElementById(`${cardId}-canvas`);
  const range = document.getElementById(`${cardId}-range`);
  const startEl = document.getElementById(`${cardId}-start`);
  const endEl = document.getElementById(`${cardId}-end`);

  if (loading) loading.style.display = 'none';
  if (canvas) { canvas.style.display = 'block'; drawSparkline(canvas, history); }
  if (range) range.style.display = 'flex';
  if (startEl) startEl.textContent = formatDate(history[0].t);
  if (endEl) endEl.textContent = formatDate(history[history.length - 1].t);
}

function showError(msg) {
  document.getElementById('content').innerHTML = `
    <div class="error-state">
      <div class="error-icon">&#x26A0;</div>
      <div class="error-title">החיבור נכשל</div>
      <div class="error-msg">${escHtml(msg)}</div>
      <button class="retry-btn" onclick="loadData()">נסה שוב</button>
    </div>`;
}

// ─── Data Loading ───
async function loadData() {
  try {
    if (allEvents.length === 0) {
      document.getElementById('content').innerHTML = `
        <div class="loading-state"><div class="loading-spinner"></div><div class="loading-text">טוען נתוני שוק...</div></div>
        <div class="skeleton-grid"><div class="skeleton-card"></div><div class="skeleton-card"></div><div class="skeleton-card"></div><div class="skeleton-card"></div><div class="skeleton-card"></div><div class="skeleton-card"></div></div>`;
    }
    await loadChartsManifest();
    allEvents = await fetchMarkets();
    renderAll();

    // Show data freshness from meta
    const meta = await fetchMeta();
    if (meta && meta.updated) {
      const updated = new Date(meta.updated);
      const ago = Math.round((Date.now() - updated.getTime()) / 60000);
      document.getElementById('lastUpdated').textContent =
        ago < 1 ? 'עכשיו' : 'לפני ' + ago + ' דק\'';
    } else {
      document.getElementById('lastUpdated').textContent = timeNow();
    }
  } catch (err) {
    console.error('Fetch error:', err);
    if (allEvents.length === 0) showError(err.message);
  }
}

// ─── Refresh Timer ───
function startRefreshCycle() {
  countdown = REFRESH_INTERVAL;
  const circle = document.getElementById('refreshProgress');
  const circ = 2 * Math.PI * 12;
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(() => {
    countdown--;
    document.getElementById('refreshCountdown').textContent = countdown + 's';
    circle.style.strokeDashoffset = circ * (1 - countdown / REFRESH_INTERVAL);
    if (countdown <= 0) { loadData(); countdown = REFRESH_INTERVAL; }
  }, 1000);
}

// ─── Event Listeners ───
document.getElementById('searchInput').addEventListener('input', (e) => { searchQuery = e.target.value; renderAll(); });
document.querySelectorAll('.sort-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentSort = btn.dataset.sort;
    renderAll();
  });
});

// ─── Init ───
loadData().then(() => startRefreshCycle());
</script>
</body>
</html>
